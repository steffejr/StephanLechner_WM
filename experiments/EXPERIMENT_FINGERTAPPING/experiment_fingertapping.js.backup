jatos.onLoad(function() {
    // Guard against double execution
    if (window.fingerTappingRunning) {
        console.log("Finger tapping already running, skipping");
        return;
    }
    window.fingerTappingRunning = true;
    
    console.log("=== FINGER TAPPING EXPERIMENT STARTING ===");

    // Get subject ID from session (set by welcome screen)
    const subjectId = jatos.studySessionData.subjectId || 'unknown';
    console.log("Subject ID:", subjectId);

    // Initialize jsPsych
    var jsPsych = initJsPsych({
        on_finish: function() {
            // DO NOT END THE STUDY HERE
        }
    });

    // Add subject ID to ALL data collected
    jsPsych.data.addProperties({
        subject_id: subjectId
    });

    // Experiment parameters
    const experimentParameters = [
        { interval: 800, condition: 'fast', description: 'Fast (0.8s intervals)' },
        { interval: 1900, condition: 'slow', description: 'Slow (1.9s intervals)' }
    ];

    // Get subject info
    function getSubjectInfo() {
        return {
            subID: subjectId || 'unknown',
            date: new Date().toISOString()
        };
    }

    const sub_info = getSubjectInfo();

    // Randomize condition order
    const randomizedConditions = [...experimentParameters].sort(() => Math.random() - 0.5);

    // Single audio element to prevent volume issues
    let audioContext;
    let beepBuffer;

    // Initialize audio
    function initAudio() {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Create beep sound programmatically
        const duration = 0.1;
        const sampleRate = audioContext.sampleRate;
        const numFrames = duration * sampleRate;
        const buffer = audioContext.createBuffer(1, numFrames, sampleRate);
        const data = buffer.getChannelData(0);

        const frequency = 450;
        for (let i = 0; i < numFrames; i++) {
            data[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 0.5;
        }

        beepBuffer = buffer;
    }

    function playBeepSound() {
        if (!audioContext) {
            initAudio();
        }

        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }

        const source = audioContext.createBufferSource();
        source.buffer = beepBuffer;

        const gainNode = audioContext.createGain();
        gainNode.gain.value = 0.5;

        source.connect(gainNode);
        gainNode.connect(audioContext.destination);

        source.start();
        source.stop(audioContext.currentTime + 0.1);
    }







    function saveData() {
        const subjectId = jatos.studySessionData.subjectId || 'unknown';
        const allData = jsPsych.data.get().values();

        // Create CSV content
        let csvContent = "trial_number,timestamp,interval,condition,phase\n";

        let trialNumber = 1;

        // Process each trial to extract tap data
        allData.forEach(trial => {
            if (trial.tap_timestamps && trial.tap_timestamps.length > 0) {
                const condition = trial.condition || 'unknown';
                const phase = trial.phase || 'unknown';

                csvContent += `${trialNumber},${trial.tap_timestamps[0].toFixed(2)},,${condition},${phase}\n`;
                trialNumber++;

                for (let i = 1; i < trial.tap_timestamps.length; i++) {
                    const timestamp = trial.tap_timestamps[i];
                    const interval = trial.tap_intervals && trial.tap_intervals[i - 1] ? trial.tap_intervals[i - 1].toFixed(2) : '';
                    csvContent += `${trialNumber},${timestamp.toFixed(2)},${interval},${condition},${phase}\n`;
                    trialNumber++;
                }
            }
        });

        // Store in study session data
        if (!jatos.studySessionData.experimentData) {
            jatos.studySessionData.experimentData = {};
        }
        
        jatos.studySessionData.experimentData.fingerTapping = {
            csv: csvContent,
            metadata: {
                subject_id: subjectId,
                date: new Date().toISOString(),
                total_taps: trialNumber - 1,
                condition_order: randomizedConditions.map(c => c.condition)
            }
        };
        
        jatos.setStudySessionData(jatos.studySessionData);
        console.log("Finger tapping data stored in session");

        // Optional: Local CSV download
        const date = new Date();
        const dateStr = date.toISOString().split('T')[0];
        const timeStr = date.toTimeString().split(':').slice(0, 2).join('');
        const filename = `${dateStr}_${timeStr}_${subjectId}_fingertapping.csv`;

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(url), 1000);

        // Continue to next component
        console.log("Finger tapping complete, calling continueToNext");
        if (window.continueToNext) {
            window.continueToNext();
        } else {
            console.error("continueToNext not found!");
        }
    }









    // Main timeline
    var timeline = [];

    // Instructions
    var instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <div style="font-size: 20px; text-align: center; max-width: 800px; margin: 0 auto; line-height: 1.4;">
                <h1>Finger Tapping Task</h1>
                <p>Next, you will complete a task where you tap a keyboard key rhythmically at two different speeds: one fast and one slow.</p>
                <p>You will hear beeps at either of these speeds. Tap along with them.</p>
                <p>When the beeps stop, keep tapping at the same rhythm while keeping your gaze on the fixation cross (+). Each speed condition will last 5 minutes. Try to maintain the original speed set by the tones.</p>
                <p>Once the fixation cross disappears, you can stop tapping.</p>
                <p><strong>Important:</strong> Use the index finger of your dominant hand to press the 'F' key. If you are left-handed, use your left index finger. If you are right-handed, use your right index finger.</p>
                <p>Press the SPACEBAR with any finger to proceed through instructions. During tapping, use ONLY the 'F' key with your index finger.</p>
                <p style="margin-top: 30px; font-weight: bold;">
                    Press SPACEBAR to begin.
                </p>
            </div>
        `,
        choices: [' '],
        on_finish: function() {
            initAudio();
        }
    };
    timeline.push(instructions);

    // Create trials for each condition
    randomizedConditions.forEach((condition, index) => {
        let tapTimestamps = [];
        let tapIntervals = [];
        let lastTapTime = null;
        let tappingStartTime = null;

        // Learning Phase
        var learning_phase = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <div style="text-align: center; font-size: 48px;">
                    <p>+</p>
                </div>
            `,
            choices: ['f'],
            trial_duration: condition.interval * 12 + 1000,
            response_ends_trial: false,
            on_start: function () {
                // Ensure audio context is active
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                console.log("Starting learning phase with interval:", condition.interval);

                const playBeepSequence = (beepNumber) => {
                    if (beepNumber < 11) {
                        setTimeout(() => {
                            playBeepSound();
                            console.log("Beep:", beepNumber + 1);
                            playBeepSequence(beepNumber + 1);
                        }, condition.interval);
                    }
                };

                setTimeout(() => {
                    playBeepSound();
                    console.log("First beep");
                    playBeepSequence(1);
                }, 500);
            },
            on_load: function() {
                // Initialize for learning phase taps
                tapTimestamps = [];
                tapIntervals = [];
                lastTapTime = null;
                tappingStartTime = performance.now();

                this.keyboardListener = function (event) {
                    if (event.code === 'KeyF') {
                        event.preventDefault();

                        const currentTime = performance.now();
                        const relativeTime = currentTime - tappingStartTime;

                        tapTimestamps.push(relativeTime);

                        if (lastTapTime !== null) {
                            const interval = relativeTime - lastTapTime;
                            tapIntervals.push(interval);
                        }

                        lastTapTime = relativeTime;
                    }
                };

                document.addEventListener('keydown', this.keyboardListener);
            },
            on_finish: function (data) {
                document.removeEventListener('keydown', this.keyboardListener);

                // Store learning phase data
                data.phase = 'learning';
                data.condition = condition.condition;
                data.tap_timestamps = tapTimestamps.slice();
                data.tap_intervals = tapIntervals.slice();

                console.log("Learning phase finished. Taps recorded:", tapTimestamps.length);
            }
        };
        timeline.push(learning_phase);

        // Tapping Phase
        var tapping_phase = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <div style="text-align: center; font-size: 48px;">
                    <p>+</p>
                </div>
            `,
            choices: ['f'],
            trial_duration: 10000, // 10 seconds for testing - change to 300000 for 5 minutes
            response_ends_trial: false,

            on_load: function () {
                tappingStartTime = performance.now();

                this.keyboardListener = function (event) {
                    if (event.code === 'KeyF') {
                        event.preventDefault();

                        const currentTime = performance.now();
                        const relativeTime = currentTime - tappingStartTime;

                        tapTimestamps.push(relativeTime);

                        if (lastTapTime !== null) {
                            const interval = relativeTime - lastTapTime;
                            tapIntervals.push(interval);
                        }

                        lastTapTime = relativeTime;

                        const tapCounter = document.getElementById('tap-counter');
                        if (tapCounter) {
                            tapCounter.textContent = 'Taps: ' + tapTimestamps.length;
                        }
                    }
                };

                document.addEventListener('keydown', this.keyboardListener);
            },

            on_finish: function (data) {
                document.removeEventListener('keydown', this.keyboardListener);

                data.phase = 'main_tapping';
                data.condition = condition.condition;
                data.tap_timestamps = tapTimestamps.slice();
                data.tap_intervals = tapIntervals.slice();

                // SAVE DATA IMMEDIATELY after each tapping phase
                if (index === randomizedConditions.length - 1) {
                    // This is the last condition, save all data
                    saveData();
                }
            }
        };
        timeline.push(tapping_phase);

        // Short break between conditions
        if (index < randomizedConditions.length - 1) {
            var break_screen = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `
                    <div style="font-size: 24px; text-align: center;">
                        <h2>Take a Break</h2>
                        <p>The next condition will start in 60 seconds.</p>
                        <p style="margin-top: 30px;">Rest your finger.</p>
                    </div>
                `,
                choices: 'NO_KEYS',
                trial_duration: 1000 // testing    60000
            };
            timeline.push(break_screen);
        }
    });

    // Global escape handler - Ctrl+C to end experiment
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'c') {
            event.preventDefault();
            saveData();
            document.body.innerHTML = `
                <div style="font-size: 24px; text-align: center; padding: 50px;">
                    <h1>Experiment Aborted</h1>
                    <p>The experiment has been stopped.</p>
                    <p>Your data has been saved.</p>
                    <p style="margin-top: 30px;">You may close this window.</p>
                </div>
            `;
            jatos.endStudy();
        }
    });

    // Start the experiment
    jsPsych.run(timeline);
});


